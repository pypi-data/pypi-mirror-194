default:
  image: ${CI_REGISTRY}/devops/images/usgs/python:3.9
  tags:
    - development

stages:
  - build
  - test
  # - deploy_local
  # - deploy_pypi

# Builds the code
.build_code:
  tags:
    - development

# Build Code:
#   artifacts:
#     paths:
#       - dist/
#   cache: {}
#   extends:
#     - .build_code
#   rules:
#     - when: always
#   script:
#     - export PATH=${PATH}:"/home/usgs-user/.local/bin"
#     - python -m pip install --upgrade pip
#     - pip install --upgrade setuptools==65.5.1
#     - pip install -e .[dev,test]
#     - pip -V
#     - pip list | grep setuptools
#     - pip list | grep build
#     - python -m build
#     - sudo apt-get install unzip -y
#     - unzip -l dist/esi_utils_geo-0.9.2-py3-none-any.whl
#     - unzip -l dist/esi_utils_geo-0.9.2-py3-none-any.whl | grep cities1000
#   stage: build

## --------------------------------------------------
# Tests the database code
## --------------------------------------------------
.test_code:
  tags:
    - development
    
Format/Test Code:
  cache: {}
  extends:
    - .test_code
  rules:
    - when: always
  script:
    - export PATH=${PATH}:"/home/usgs-user/.local/bin"
    - echo ${PATH}
    - pip install -e .[dev,test]
    - black src/esi_utils_geo/*.py
    - pytest .
  stage: test

# --------------------------------------------------
# Deploy the pip package
# --------------------------------------------------
.deploy_local:
  tags:
    - development

.deploy_pypi:
  tags:
    - development
    
# Deploy Code to code.usgs.gov:
#   cache: {}
#   extends:
#     - .deploy_local
#   # only:
#   #   refs:
#   #     - tags
#   rules:
#     - when: manual
#   when: manual
#   script:
#     - pip install twine
#     - echo "Deploying to gitlab package registry!"
#     - export PATH=${PATH}:"/home/usgs-user/.local/bin"
#     - |
#       TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token \
#         python -m twine upload --verbose \
#         --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi \
#         dist/*
#   stage: deploy_local

# Deploy Code to PyPI:
#   cache: {}
#   extends:
#     - .deploy_pypi
#   # only:
#   #   refs:
#   #     - tags
#   rules:
#     - when: manual
#   when: manual
#   script:
#     - pip install twine
#     - echo "Deploying to PyPI!"
#     - python -m twine upload --verbose dist/*
#   stage: deploy_pypi