$def with (ip_address, onion)
$ homedir = "/home/gaea"
user  gaea  gaea;
load_module "modules/ngx_rtmp_module.so";

worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    types_hash_max_size            2048;
    sendfile                       on;
    tcp_nopush                     on;
    tcp_nodelay                    on;
    keepalive_timeout              65;
    server_tokens                  off;
    server_names_hash_bucket_size  128;

    gzip          on;
    gzip_disable  "msie6";

    # access_log  /root/nginx/logs/access.log;
    # error_log   /root/nginx/logs/error.log;

    # log_format  gaeafmt  '$$remote_addr [$$time_local] "$$request" $$status '
    #                      '$$request_time $$bytes_sent "$$http_referer" '
    #                      '"$$http_user_agent" "$$sent_http_set_cookie"';

    # include /root/nginx/conf/conf.d/*.conf;

    server {
        listen       80;
        server_name  $ip_address  $onion;
        charset      utf-8;

        client_max_body_size  0;

        location  /hls  {
            root  /home/gaea/media/streaming;
            add_header  Cache-Control  no-cache;
            add_header  Access-Control-Allow-Origin  *;
            types {
                application/vnd.apple.mpegurl  m3u8;
            }
        }

        location  /  {
            proxy_set_header  X-Forwarded-Proto  $$scheme;
            proxy_set_header  Host  $$http_host;
            proxy_set_header  X-Forwarded-For  $$proxy_add_x_forwarded_for;
            proxy_redirect  off;
            proxy_pass  http://unix:$homedir/app/run/gunicorn.sock;
        }

        # location  ~  ^/(.*)$$  {
        #     alias      /var/www/;
        #     try_files  $$1.html  =404;
        # }
        # error_page   403 404          /error/40x.html;
        # error_page   500 502 503 504  /error/50x.html;
        # access_log   /root/trunk/access.log  gaeafmt;
        # error_log    /root/trunk/error.log   info;
    }
}

rtmp {
    # Define where the HLS files will be written. Viewers will be fetching
    # these files from the browser, so the `location /hls` above points to
    # this folder as well
    hls on;
    hls_path $homedir/media/streaming/hls;
    hls_fragment 5s;

    # Enable recording archived files of each stream
    # Does not need to be publicly accessible, will convert and publish later
    record all;
    record_path $homedir/media/streaming/rec;
    record_suffix _%Y-%m-%d_%H-%M-%S.flv;
    record_lock on;

    # Define the two scripts that will run when recording starts and when
    # it finishes
    exec_publish $homedir/streaming/publish.sh;
    exec_record_done $homedir/streaming/finished.sh $$path $$basename.mp4;

    access_log /var/log/nginx/rtmp_access.log combined;
    access_log on;

    server {
        listen 1935;
        chunk_size 4096;

        application live {
            live on;
            record all;
            # push rtmp://localhost/twitch;
            # push rtmp://localhost/youtube;
        }
        application twitch {
            live on;
            record off;
            allow publish 127.0.0.1;
            deny publish all;
            push rtmp://lax.contribute.live-video.net/app/live_784014614_hwNuA2Gl5fz3SxETlrFcMmk0H2qynG;
        }
        application youtube {
            live on;
            record off;
            allow publish 127.0.0.1;
            deny publish all;
            push rtmp://a.rtmp.youtube.com/live2/4505-6umr-xemj-tm3g-959h;
        }
    }
}

# leave this here for cat'ing over SSH...
